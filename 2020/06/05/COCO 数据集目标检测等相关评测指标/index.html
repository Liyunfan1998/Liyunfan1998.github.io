<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="COCO 数据集目标检测等相关评测指标转载自 https://www.aiuai.cn/aifarm854.html

COCO Detection Evaluation

1. 评测指标定义COCO 提供了 12 种用于衡量目标检测器性能的评价指标.

image
[1] - 除非特别说明，AP ">
    

    <!--Author-->
    
        <meta name="author" content="Yunfan Li">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="COCO 数据集目标检测等相关评测指标"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Hexo"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    
        <meta name="twitter:card" content="summary" />
    
    
    

    <!-- Title -->
    
    <title>COCO 数据集目标检测等相关评测指标 - Hexo</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Google Analytics -->
    


<meta name="generator" content="Hexo 4.2.0"></head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/archives">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2020/06/05/COCO%20%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%AD%89%E7%9B%B8%E5%85%B3%E8%AF%84%E6%B5%8B%E6%8C%87%E6%A0%87/">
                COCO 数据集目标检测等相关评测指标
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2020-06-05</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h1 id="COCO-数据集目标检测等相关评测指标"><a href="#COCO-数据集目标检测等相关评测指标" class="headerlink" title="COCO 数据集目标检测等相关评测指标"></a>COCO 数据集目标检测等相关评测指标</h1><p>转载自 <a href="https://www.aiuai.cn/aifarm854.html" target="_blank" rel="noopener">https://www.aiuai.cn/aifarm854.html</a></p>
<blockquote>
<p><a href="http://cocodataset.org/#detection-eval" target="_blank" rel="noopener">COCO Detection Evaluation</a></p>
</blockquote>
<h2 id="1-评测指标定义"><a href="#1-评测指标定义" class="headerlink" title="1. 评测指标定义"></a>1. 评测指标定义</h2><p>COCO 提供了 12 种用于衡量目标检测器性能的评价指标.</p>
<p><a href="https://aiuai.cn/uploads/1905/3c3629c01306058c.png" target="_blank" rel="noopener"><img src="https://aiuai.cn/uploads/1905/3c3629c01306058c.png" alt="image"></a></p>
<p><a href="https://aiuai.cn/uploads/1905/3c3629c01306058c.png" target="_blank" rel="noopener">image</a></p>
<p>[1] - 除非特别说明，AP 和 AR 一般是在多个 IoU(Intersection over Union) 值间取平均值. 具体地，采用了 10 个 IoU阈值 - <strong>0.50:0.05:0.95</strong>. 对比于传统的只计算单个 IoU 阈值(<strong>0.50</strong>)的指标(对应于这里的指标 APIoU=0.50)，这是一种突破. 对多个 IoU 阈值求平均，能够使得目标检测器具有更好的定位位置.</p>
<p>[2] - AP 是对所有类别的求平均值. 这在传统上被称为<strong>平均准确度(mAP, mean average precision)</strong>. 这里并未区分 AP 和 mAP(类似的，AR 和mAR)，假定从上下文中具有清晰的差异. 即：如，AP50=mAP50，AP75=mAP75，… 但，AP50 一定大于 AP75.</p>
<p>[3] - AP (所有 10 个 IoU 阈值和全部 80 个类别的平均值) 作为最终 COCO竞赛胜者的标准. 在考虑目标检测器再 COCO 上的性能时，这是单个最重要的评价度量指标.</p>
<p>[4] - COCO数据集中小目标物体数量比大目标物体更多. 具体地，标注的约有 41% 的目标物体是都很小的(small, 面积&lt; 32x32=1024)，约有 34% 的目标物体是中等的(medium, 1024=32x32 &lt; 面积 &lt; 96x96=9216)，约有 24% 的目标物体是大的(large, 面积 &gt; 96x96=9216). <strong>面积(area) 是指 segmentation mask 中像素的数量</strong>.</p>
<p>[5] - AR 是指每张图片中，在给定固定数量的检测结果中的最大召回(maximum recall)，在所有 IoUs 和全部类别上求平均值. AR 与 <strong><a href="https://arxiv.org/abs/1502.05082" target="_blank" rel="noopener">proposal evaluation</a></strong> 中所使用的相同，但这里 AR 是按类别计算的.</p>
<p>[6] - 所有的评测指标允许每张图片(在全部的类别中)最多 100 个 top-scoring 检测结果进行计算.</p>
<p>[7] - 边界框(bounding boxes)的检测和segmentation mask 的所有评测指标是一致的，除了 IoU 的计算. 边界框的 IoU 计算是关于 boxes的 ，而 segmentation mask 的 IoU 计算是关于 masks 的.</p>
<h2 id="2-评测指标实现-cocoeval"><a href="#2-评测指标实现-cocoeval" class="headerlink" title="2. 评测指标实现 - cocoeval"></a>2. 评测指标实现 - cocoeval</h2><blockquote>
<p><a href="https://github.com/cocodataset/cocoapi/blob/master/PythonAPI/pycocotools/cocoeval.py" target="_blank" rel="noopener">PythonAPI/pycocotools/cocoeval.py</a></p>
</blockquote>
<p>评测参数如 ：(括号里的默认值，一般不需要修改.)</p>
<p><a href="https://aiuai.cn/uploads/1905/1466342d14364de7.png" target="_blank" rel="noopener"><img src="https://aiuai.cn/uploads/1905/1466342d14364de7.png" alt="image"></a></p>
<p><a href="https://aiuai.cn/uploads/1905/1466342d14364de7.png" target="_blank" rel="noopener">image</a></p>
<p>通过调用 <code>evaluate()</code> 函数和 <code>accumulate()</code> 函数来运行，以计算得到衡量检测质量的两个数据结构(data structures).</p>
<p>这两个数据结构分别是 <code>evalImages</code> 和 <code>eval</code>，其分别每张图片的检测质量和整个数据集上的聚合检测质量.</p>
<p>数据结构 <code>evalImages</code> 共有 KxA 个元素，每个元素表示一个评测设置；而数据结构 <code>eval</code> 将这些信息组合为 precision 和 recall 数组. 具体如下：</p>
<p><a href="https://aiuai.cn/uploads/1905/b48d28af86a1b671.png" target="_blank" rel="noopener"><img src="https://aiuai.cn/uploads/1905/b48d28af86a1b671.png" alt="image"></a></p>
<p><a href="https://aiuai.cn/uploads/1905/b48d28af86a1b671.png" target="_blank" rel="noopener">image</a></p>
<p>Python 中的定义如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br></pre></td><td class="code"><pre><span class="line">__author__ = <span class="string">'tsungyi'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> mask <span class="keyword">as</span> maskUtils</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">COCOeval</span>:</span></span><br><span class="line">    <span class="comment"># COCO 数据集的检测评估接口.</span></span><br><span class="line">    <span class="comment"># The usage for CocoEval is as follows:</span></span><br><span class="line">    <span class="comment">#  cocoGt=..., cocoDt=...       # load dataset and results</span></span><br><span class="line">    <span class="comment">#  E = CocoEval(cocoGt,cocoDt); # initialize CocoEval object</span></span><br><span class="line">    <span class="comment">#  E.params.recThrs = ...;      # set parameters as desired</span></span><br><span class="line">    <span class="comment">#  E.evaluate();                # run per image evaluation</span></span><br><span class="line">    <span class="comment">#  E.accumulate();              # accumulate per image results</span></span><br><span class="line">    <span class="comment">#  E.summarize();               # display summary metrics of results</span></span><br><span class="line">    <span class="comment"># For example usage see evalDemo.m and http://mscoco.org/.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># The evaluation parameters are as follows (defaults in brackets):</span></span><br><span class="line">    <span class="comment">#  imgIds     - [all] N img ids to use for evaluation</span></span><br><span class="line">    <span class="comment">#  catIds     - [all] K cat ids to use for evaluation</span></span><br><span class="line">    <span class="comment">#  iouThrs    - [.5:.05:.95] T=10 IoU thresholds for evaluation</span></span><br><span class="line">    <span class="comment">#  recThrs    - [0:.01:1] R=101 recall thresholds for evaluation</span></span><br><span class="line">    <span class="comment">#  areaRng    - [...] A=4 object area ranges for evaluation</span></span><br><span class="line">    <span class="comment">#  maxDets    - [1 10 100] M=3 thresholds on max detections per image</span></span><br><span class="line">    <span class="comment">#  iouType    - ['segm'] set iouType to 'segm', 'bbox' or 'keypoints'</span></span><br><span class="line">    <span class="comment">#  iouType replaced the now DEPRECATED useSegm parameter.</span></span><br><span class="line">    <span class="comment">#  useCats    - [1] if true use category labels for evaluation</span></span><br><span class="line">    <span class="comment"># Note: if useCats=0 category labels are ignored as in proposal scoring.</span></span><br><span class="line">    <span class="comment"># Note: multiple areaRngs [Ax2] and maxDets [Mx1] can be specified.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># evaluate(): evaluates detections on every image and every category and</span></span><br><span class="line">    <span class="comment"># concats the results into the "evalImgs" with fields:</span></span><br><span class="line">    <span class="comment">#  dtIds      - [1xD] id for each of the D detections (dt)</span></span><br><span class="line">    <span class="comment">#  gtIds      - [1xG] id for each of the G ground truths (gt)</span></span><br><span class="line">    <span class="comment">#  dtMatches  - [TxD] matching gt id at each IoU or 0</span></span><br><span class="line">    <span class="comment">#  gtMatches  - [TxG] matching dt id at each IoU or 0</span></span><br><span class="line">    <span class="comment">#  dtScores   - [1xD] confidence of each dt</span></span><br><span class="line">    <span class="comment">#  gtIgnore   - [1xG] ignore flag for each gt</span></span><br><span class="line">    <span class="comment">#  dtIgnore   - [TxD] ignore flag for each dt at each IoU</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># accumulate(): accumulates the per-image, per-category evaluation</span></span><br><span class="line">    <span class="comment"># results in "evalImgs" into the dictionary "eval" with fields:</span></span><br><span class="line">    <span class="comment">#  params     - parameters used for evaluation</span></span><br><span class="line">    <span class="comment">#  date       - date evaluation was performed</span></span><br><span class="line">    <span class="comment">#  counts     - [T,R,K,A,M] parameter dimensions (see above)</span></span><br><span class="line">    <span class="comment">#  precision  - [TxRxKxAxM] precision for every evaluation setting</span></span><br><span class="line">    <span class="comment">#  recall     - [TxKxAxM] max recall for every evaluation setting</span></span><br><span class="line">    <span class="comment"># Note: precision and recall==-1 for settings with no gt objects.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># See also coco, mask, pycocoDemo, pycocoEvalDemo</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cocoGt=None, cocoDt=None, iouType=<span class="string">'segm'</span>)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        Initialize CocoEval using coco APIs for gt and dt</span></span><br><span class="line"><span class="string">        :param cocoGt: coco object with ground truth annotations</span></span><br><span class="line"><span class="string">        :param cocoDt: coco object with detection results</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> iouType:</span><br><span class="line">            print(<span class="string">'iouType not specified. use default iouType segm'</span>)</span><br><span class="line">        self.cocoGt   = cocoGt              <span class="comment"># ground truth COCO API</span></span><br><span class="line">        self.cocoDt   = cocoDt              <span class="comment"># detections COCO API</span></span><br><span class="line">        self.params   = &#123;&#125;                  <span class="comment"># evaluation parameters</span></span><br><span class="line">        self.evalImgs = defaultdict(list)   <span class="comment"># per-image per-category evaluation results [KxAxI] elements</span></span><br><span class="line">        self.eval     = &#123;&#125;                  <span class="comment"># accumulated evaluation results</span></span><br><span class="line">        self._gts = defaultdict(list)       <span class="comment"># gt for evaluation</span></span><br><span class="line">        self._dts = defaultdict(list)       <span class="comment"># dt for evaluation</span></span><br><span class="line">        self.params = Params(iouType=iouType) <span class="comment"># parameters</span></span><br><span class="line">        self._paramsEval = &#123;&#125;               <span class="comment"># parameters for evaluation</span></span><br><span class="line">        self.stats = []                     <span class="comment"># result summarization</span></span><br><span class="line">        self.ious = &#123;&#125;                      <span class="comment"># ious between all gts and dts</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cocoGt <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.params.imgIds = sorted(cocoGt.getImgIds())</span><br><span class="line">            self.params.catIds = sorted(cocoGt.getCatIds())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_prepare</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        Prepare ._gts and ._dts for evaluation based on params</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_toMask</span><span class="params">(anns, coco)</span>:</span></span><br><span class="line">            <span class="comment"># modify ann['segmentation'] by reference</span></span><br><span class="line">            <span class="keyword">for</span> ann <span class="keyword">in</span> anns:</span><br><span class="line">                rle = coco.annToRLE(ann)</span><br><span class="line">                ann[<span class="string">'segmentation'</span>] = rle</span><br><span class="line">        p = self.params</span><br><span class="line">        <span class="keyword">if</span> p.useCats:</span><br><span class="line">            gts=self.cocoGt.loadAnns(self.cocoGt.getAnnIds(imgIds=p.imgIds, catIds=p.catIds))</span><br><span class="line">            dts=self.cocoDt.loadAnns(self.cocoDt.getAnnIds(imgIds=p.imgIds, catIds=p.catIds))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gts=self.cocoGt.loadAnns(self.cocoGt.getAnnIds(imgIds=p.imgIds))</span><br><span class="line">            dts=self.cocoDt.loadAnns(self.cocoDt.getAnnIds(imgIds=p.imgIds))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># convert ground truth to mask if iouType == 'segm'</span></span><br><span class="line">        <span class="keyword">if</span> p.iouType == <span class="string">'segm'</span>:</span><br><span class="line">            _toMask(gts, self.cocoGt)</span><br><span class="line">            _toMask(dts, self.cocoDt)</span><br><span class="line">        <span class="comment"># set ignore flag</span></span><br><span class="line">        <span class="keyword">for</span> gt <span class="keyword">in</span> gts:</span><br><span class="line">            gt[<span class="string">'ignore'</span>] = gt[<span class="string">'ignore'</span>] <span class="keyword">if</span> <span class="string">'ignore'</span> <span class="keyword">in</span> gt <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            gt[<span class="string">'ignore'</span>] = <span class="string">'iscrowd'</span> <span class="keyword">in</span> gt <span class="keyword">and</span> gt[<span class="string">'iscrowd'</span>]</span><br><span class="line">            <span class="keyword">if</span> p.iouType == <span class="string">'keypoints'</span>:</span><br><span class="line">                gt[<span class="string">'ignore'</span>] = (gt[<span class="string">'num_keypoints'</span>] == <span class="number">0</span>) <span class="keyword">or</span> gt[<span class="string">'ignore'</span>]</span><br><span class="line">        self._gts = defaultdict(list)       <span class="comment"># gt for evaluation</span></span><br><span class="line">        self._dts = defaultdict(list)       <span class="comment"># dt for evaluation</span></span><br><span class="line">        <span class="keyword">for</span> gt <span class="keyword">in</span> gts:</span><br><span class="line">            self._gts[gt[<span class="string">'image_id'</span>], gt[<span class="string">'category_id'</span>]].append(gt)</span><br><span class="line">        <span class="keyword">for</span> dt <span class="keyword">in</span> dts:</span><br><span class="line">            self._dts[dt[<span class="string">'image_id'</span>], dt[<span class="string">'category_id'</span>]].append(dt)</span><br><span class="line">        self.evalImgs = defaultdict(list)   <span class="comment"># per-image per-category evaluation results</span></span><br><span class="line">        self.eval     = &#123;&#125;                  <span class="comment"># accumulated evaluation results</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">evaluate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        Run per image evaluation on given images and store results (a list of dict) in self.evalImgs</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        tic = time.time()</span><br><span class="line">        print(<span class="string">'Running per image evaluation...'</span>)</span><br><span class="line">        p = self.params</span><br><span class="line">        <span class="comment"># add backward compatibility if useSegm is specified in params</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> p.useSegm <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            p.iouType = <span class="string">'segm'</span> <span class="keyword">if</span> p.useSegm == <span class="number">1</span> <span class="keyword">else</span> <span class="string">'bbox'</span></span><br><span class="line">            print(<span class="string">'useSegm (deprecated) is not None. Running &#123;&#125; evaluation'</span>.format(p.iouType))</span><br><span class="line">        print(<span class="string">'Evaluate annotation type *&#123;&#125;*'</span>.format(p.iouType))</span><br><span class="line">        p.imgIds = list(np.unique(p.imgIds))</span><br><span class="line">        <span class="keyword">if</span> p.useCats:</span><br><span class="line">            p.catIds = list(np.unique(p.catIds))</span><br><span class="line">        p.maxDets = sorted(p.maxDets)</span><br><span class="line">        self.params=p</span><br><span class="line"></span><br><span class="line">        self._prepare()</span><br><span class="line">        <span class="comment"># loop through images, area range, max detection number</span></span><br><span class="line">        catIds = p.catIds <span class="keyword">if</span> p.useCats <span class="keyword">else</span> [<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> p.iouType == <span class="string">'segm'</span> <span class="keyword">or</span> p.iouType == <span class="string">'bbox'</span>:</span><br><span class="line">            computeIoU = self.computeIoU</span><br><span class="line">        <span class="keyword">elif</span> p.iouType == <span class="string">'keypoints'</span>:</span><br><span class="line">            computeIoU = self.computeOks</span><br><span class="line">        self.ious = &#123;(imgId, catId): computeIoU(imgId, catId) \</span><br><span class="line">                        <span class="keyword">for</span> imgId <span class="keyword">in</span> p.imgIds</span><br><span class="line">                        <span class="keyword">for</span> catId <span class="keyword">in</span> catIds&#125;</span><br><span class="line"></span><br><span class="line">        evaluateImg = self.evaluateImg</span><br><span class="line">        maxDet = p.maxDets[<span class="number">-1</span>]</span><br><span class="line">        self.evalImgs = [evaluateImg(imgId, catId, areaRng, maxDet)</span><br><span class="line">                 <span class="keyword">for</span> catId <span class="keyword">in</span> catIds</span><br><span class="line">                 <span class="keyword">for</span> areaRng <span class="keyword">in</span> p.areaRng</span><br><span class="line">                 <span class="keyword">for</span> imgId <span class="keyword">in</span> p.imgIds</span><br><span class="line">             ]</span><br><span class="line">        self._paramsEval = copy.deepcopy(self.params)</span><br><span class="line">        toc = time.time()</span><br><span class="line">        print(<span class="string">'DONE (t=&#123;:0.2f&#125;s).'</span>.format(toc-tic))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">computeIoU</span><span class="params">(self, imgId, catId)</span>:</span></span><br><span class="line">        p = self.params</span><br><span class="line">        <span class="keyword">if</span> p.useCats:</span><br><span class="line">            gt = self._gts[imgId,catId]</span><br><span class="line">            dt = self._dts[imgId,catId]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gt = [_ <span class="keyword">for</span> cId <span class="keyword">in</span> p.catIds <span class="keyword">for</span> _ <span class="keyword">in</span> self._gts[imgId,cId]]</span><br><span class="line">            dt = [_ <span class="keyword">for</span> cId <span class="keyword">in</span> p.catIds <span class="keyword">for</span> _ <span class="keyword">in</span> self._dts[imgId,cId]]</span><br><span class="line">        <span class="keyword">if</span> len(gt) == <span class="number">0</span> <span class="keyword">and</span> len(dt) ==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        inds = np.argsort([-d[<span class="string">'score'</span>] <span class="keyword">for</span> d <span class="keyword">in</span> dt], kind=<span class="string">'mergesort'</span>)</span><br><span class="line">        dt = [dt[i] <span class="keyword">for</span> i <span class="keyword">in</span> inds]</span><br><span class="line">        <span class="keyword">if</span> len(dt) &gt; p.maxDets[<span class="number">-1</span>]:</span><br><span class="line">            dt=dt[<span class="number">0</span>:p.maxDets[<span class="number">-1</span>]]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> p.iouType == <span class="string">'segm'</span>:</span><br><span class="line">            g = [g[<span class="string">'segmentation'</span>] <span class="keyword">for</span> g <span class="keyword">in</span> gt]</span><br><span class="line">            d = [d[<span class="string">'segmentation'</span>] <span class="keyword">for</span> d <span class="keyword">in</span> dt]</span><br><span class="line">        <span class="keyword">elif</span> p.iouType == <span class="string">'bbox'</span>:</span><br><span class="line">            g = [g[<span class="string">'bbox'</span>] <span class="keyword">for</span> g <span class="keyword">in</span> gt]</span><br><span class="line">            d = [d[<span class="string">'bbox'</span>] <span class="keyword">for</span> d <span class="keyword">in</span> dt]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'unknown iouType for iou computation'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># compute iou between each dt and gt region</span></span><br><span class="line">        iscrowd = [int(o[<span class="string">'iscrowd'</span>]) <span class="keyword">for</span> o <span class="keyword">in</span> gt]</span><br><span class="line">        ious = maskUtils.iou(d,g,iscrowd)</span><br><span class="line">        <span class="keyword">return</span> ious</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">computeOks</span><span class="params">(self, imgId, catId)</span>:</span></span><br><span class="line">        p = self.params</span><br><span class="line">        <span class="comment"># dimention here should be Nxm</span></span><br><span class="line">        gts = self._gts[imgId, catId]</span><br><span class="line">        dts = self._dts[imgId, catId]</span><br><span class="line">        inds = np.argsort([-d[<span class="string">'score'</span>] <span class="keyword">for</span> d <span class="keyword">in</span> dts], kind=<span class="string">'mergesort'</span>)</span><br><span class="line">        dts = [dts[i] <span class="keyword">for</span> i <span class="keyword">in</span> inds]</span><br><span class="line">        <span class="keyword">if</span> len(dts) &gt; p.maxDets[<span class="number">-1</span>]:</span><br><span class="line">            dts = dts[<span class="number">0</span>:p.maxDets[<span class="number">-1</span>]]</span><br><span class="line">        <span class="comment"># if len(gts) == 0 and len(dts) == 0:</span></span><br><span class="line">        <span class="keyword">if</span> len(gts) == <span class="number">0</span> <span class="keyword">or</span> len(dts) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        ious = np.zeros((len(dts), len(gts)))</span><br><span class="line">        sigmas = np.array([<span class="number">.26</span>, <span class="number">.25</span>, <span class="number">.25</span>, <span class="number">.35</span>, <span class="number">.35</span>, <span class="number">.79</span>, <span class="number">.79</span>, <span class="number">.72</span>, <span class="number">.72</span>, <span class="number">.62</span>,<span class="number">.62</span>, <span class="number">1.07</span>, <span class="number">1.07</span>, <span class="number">.87</span>, <span class="number">.87</span>, <span class="number">.89</span>, <span class="number">.89</span>])/<span class="number">10.0</span></span><br><span class="line">        vars = (sigmas * <span class="number">2</span>)**<span class="number">2</span></span><br><span class="line">        k = len(sigmas)</span><br><span class="line">        <span class="comment"># compute oks between each detection and ground truth object</span></span><br><span class="line">        <span class="keyword">for</span> j, gt <span class="keyword">in</span> enumerate(gts):</span><br><span class="line">            <span class="comment"># create bounds for ignore regions(double the gt bbox)</span></span><br><span class="line">            g = np.array(gt[<span class="string">'keypoints'</span>])</span><br><span class="line">            xg = g[<span class="number">0</span>::<span class="number">3</span>]; yg = g[<span class="number">1</span>::<span class="number">3</span>]; vg = g[<span class="number">2</span>::<span class="number">3</span>]</span><br><span class="line">            k1 = np.count_nonzero(vg &gt; <span class="number">0</span>)</span><br><span class="line">            bb = gt[<span class="string">'bbox'</span>]</span><br><span class="line">            x0 = bb[<span class="number">0</span>] - bb[<span class="number">2</span>]; x1 = bb[<span class="number">0</span>] + bb[<span class="number">2</span>] * <span class="number">2</span></span><br><span class="line">            y0 = bb[<span class="number">1</span>] - bb[<span class="number">3</span>]; y1 = bb[<span class="number">1</span>] + bb[<span class="number">3</span>] * <span class="number">2</span></span><br><span class="line">            <span class="keyword">for</span> i, dt <span class="keyword">in</span> enumerate(dts):</span><br><span class="line">                d = np.array(dt[<span class="string">'keypoints'</span>])</span><br><span class="line">                xd = d[<span class="number">0</span>::<span class="number">3</span>]; yd = d[<span class="number">1</span>::<span class="number">3</span>]</span><br><span class="line">                <span class="keyword">if</span> k1&gt;<span class="number">0</span>:</span><br><span class="line">                    <span class="comment"># measure the per-keypoint distance if keypoints visible</span></span><br><span class="line">                    dx = xd - xg</span><br><span class="line">                    dy = yd - yg</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># measure minimum distance to keypoints in (x0,y0) &amp; (x1,y1)</span></span><br><span class="line">                    z = np.zeros((k))</span><br><span class="line">                    dx = np.max((z, x0-xd),axis=<span class="number">0</span>)+np.max((z, xd-x1),axis=<span class="number">0</span>)</span><br><span class="line">                    dy = np.max((z, y0-yd),axis=<span class="number">0</span>)+np.max((z, yd-y1),axis=<span class="number">0</span>)</span><br><span class="line">                e = (dx**<span class="number">2</span> + dy**<span class="number">2</span>) / vars / (gt[<span class="string">'area'</span>]+np.spacing(<span class="number">1</span>)) / <span class="number">2</span></span><br><span class="line">                <span class="keyword">if</span> k1 &gt; <span class="number">0</span>:</span><br><span class="line">                    e=e[vg &gt; <span class="number">0</span>]</span><br><span class="line">                ious[i, j] = np.sum(np.exp(-e)) / e.shape[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> ious</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">evaluateImg</span><span class="params">(self, imgId, catId, aRng, maxDet)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        perform evaluation for single category and image</span></span><br><span class="line"><span class="string">        :return: dict (single image results)</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        p = self.params</span><br><span class="line">        <span class="keyword">if</span> p.useCats:</span><br><span class="line">            gt = self._gts[imgId,catId]</span><br><span class="line">            dt = self._dts[imgId,catId]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            gt = [_ <span class="keyword">for</span> cId <span class="keyword">in</span> p.catIds <span class="keyword">for</span> _ <span class="keyword">in</span> self._gts[imgId,cId]]</span><br><span class="line">            dt = [_ <span class="keyword">for</span> cId <span class="keyword">in</span> p.catIds <span class="keyword">for</span> _ <span class="keyword">in</span> self._dts[imgId,cId]]</span><br><span class="line">        <span class="keyword">if</span> len(gt) == <span class="number">0</span> <span class="keyword">and</span> len(dt) ==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> g <span class="keyword">in</span> gt:</span><br><span class="line">            <span class="keyword">if</span> g[<span class="string">'ignore'</span>] <span class="keyword">or</span> (g[<span class="string">'area'</span>]&lt;aRng[<span class="number">0</span>] <span class="keyword">or</span> g[<span class="string">'area'</span>]&gt;aRng[<span class="number">1</span>]):</span><br><span class="line">                g[<span class="string">'_ignore'</span>] = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                g[<span class="string">'_ignore'</span>] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># sort dt highest score first, sort gt ignore last</span></span><br><span class="line">        gtind = np.argsort([g[<span class="string">'_ignore'</span>] <span class="keyword">for</span> g <span class="keyword">in</span> gt], kind=<span class="string">'mergesort'</span>)</span><br><span class="line">        gt = [gt[i] <span class="keyword">for</span> i <span class="keyword">in</span> gtind]</span><br><span class="line">        dtind = np.argsort([-d[<span class="string">'score'</span>] <span class="keyword">for</span> d <span class="keyword">in</span> dt], kind=<span class="string">'mergesort'</span>)</span><br><span class="line">        dt = [dt[i] <span class="keyword">for</span> i <span class="keyword">in</span> dtind[<span class="number">0</span>:maxDet]]</span><br><span class="line">        iscrowd = [int(o[<span class="string">'iscrowd'</span>]) <span class="keyword">for</span> o <span class="keyword">in</span> gt]</span><br><span class="line">        <span class="comment"># load computed ious</span></span><br><span class="line">        ious = self.ious[imgId, catId][:, gtind] <span class="keyword">if</span> len(self.ious[imgId, catId]) &gt; <span class="number">0</span> <span class="keyword">else</span> self.ious[imgId, catId]</span><br><span class="line"></span><br><span class="line">        T = len(p.iouThrs)</span><br><span class="line">        G = len(gt)</span><br><span class="line">        D = len(dt)</span><br><span class="line">        gtm  = np.zeros((T,G))</span><br><span class="line">        dtm  = np.zeros((T,D))</span><br><span class="line">        gtIg = np.array([g[<span class="string">'_ignore'</span>] <span class="keyword">for</span> g <span class="keyword">in</span> gt])</span><br><span class="line">        dtIg = np.zeros((T,D))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> len(ious)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">for</span> tind, t <span class="keyword">in</span> enumerate(p.iouThrs):</span><br><span class="line">                <span class="keyword">for</span> dind, d <span class="keyword">in</span> enumerate(dt):</span><br><span class="line">                    <span class="comment"># information about best match so far (m=-1 -&gt; unmatched)</span></span><br><span class="line">                    iou = min([t,<span class="number">1</span><span class="number">-1e-10</span>])</span><br><span class="line">                    m   = <span class="number">-1</span></span><br><span class="line">                    <span class="keyword">for</span> gind, g <span class="keyword">in</span> enumerate(gt):</span><br><span class="line">                        <span class="comment"># if this gt already matched, and not a crowd, continue</span></span><br><span class="line">                        <span class="keyword">if</span> gtm[tind,gind]&gt;<span class="number">0</span> <span class="keyword">and</span> <span class="keyword">not</span> iscrowd[gind]:</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                        <span class="comment"># if dt matched to reg gt, and on ignore gt, stop</span></span><br><span class="line">                        <span class="keyword">if</span> m&gt;<span class="number">-1</span> <span class="keyword">and</span> gtIg[m]==<span class="number">0</span> <span class="keyword">and</span> gtIg[gind]==<span class="number">1</span>:</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                        <span class="comment"># continue to next gt unless better match made</span></span><br><span class="line">                        <span class="keyword">if</span> ious[dind,gind] &lt; iou:</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                        <span class="comment"># if match successful and best so far, store appropriately</span></span><br><span class="line">                        iou=ious[dind,gind]</span><br><span class="line">                        m=gind</span><br><span class="line">                    <span class="comment"># if match made store id of match for both dt and gt</span></span><br><span class="line">                    <span class="keyword">if</span> m ==<span class="number">-1</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    dtIg[tind,dind] = gtIg[m]</span><br><span class="line">                    dtm[tind,dind]  = gt[m][<span class="string">'id'</span>]</span><br><span class="line">                    gtm[tind,m]     = d[<span class="string">'id'</span>]</span><br><span class="line">        <span class="comment"># set unmatched detections outside of area range to ignore</span></span><br><span class="line">        a = np.array([d[<span class="string">'area'</span>]&lt;aRng[<span class="number">0</span>] <span class="keyword">or</span> d[<span class="string">'area'</span>]&gt;aRng[<span class="number">1</span>] <span class="keyword">for</span> d <span class="keyword">in</span> dt]).reshape((<span class="number">1</span>, len(dt)))</span><br><span class="line">        dtIg = np.logical_or(dtIg, np.logical_and(dtm==<span class="number">0</span>, np.repeat(a,T,<span class="number">0</span>)))</span><br><span class="line">        <span class="comment"># store results for given image and category</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">'image_id'</span>:     imgId,</span><br><span class="line">                <span class="string">'category_id'</span>:  catId,</span><br><span class="line">                <span class="string">'aRng'</span>:         aRng,</span><br><span class="line">                <span class="string">'maxDet'</span>:       maxDet,</span><br><span class="line">                <span class="string">'dtIds'</span>:        [d[<span class="string">'id'</span>] <span class="keyword">for</span> d <span class="keyword">in</span> dt],</span><br><span class="line">                <span class="string">'gtIds'</span>:        [g[<span class="string">'id'</span>] <span class="keyword">for</span> g <span class="keyword">in</span> gt],</span><br><span class="line">                <span class="string">'dtMatches'</span>:    dtm,</span><br><span class="line">                <span class="string">'gtMatches'</span>:    gtm,</span><br><span class="line">                <span class="string">'dtScores'</span>:     [d[<span class="string">'score'</span>] <span class="keyword">for</span> d <span class="keyword">in</span> dt],</span><br><span class="line">                <span class="string">'gtIgnore'</span>:     gtIg,</span><br><span class="line">                <span class="string">'dtIgnore'</span>:     dtIg,</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">accumulate</span><span class="params">(self, p = None)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        Accumulate per image evaluation results and store the result in self.eval</span></span><br><span class="line"><span class="string">        :param p: input params for evaluation</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        print(<span class="string">'Accumulating evaluation results...'</span>)</span><br><span class="line">        tic = time.time()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.evalImgs:</span><br><span class="line">            print(<span class="string">'Please run evaluate() first'</span>)</span><br><span class="line">        <span class="comment"># allows input customized parameters</span></span><br><span class="line">        <span class="keyword">if</span> p <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            p = self.params</span><br><span class="line">        p.catIds = p.catIds <span class="keyword">if</span> p.useCats == <span class="number">1</span> <span class="keyword">else</span> [<span class="number">-1</span>]</span><br><span class="line">        T           = len(p.iouThrs)</span><br><span class="line">        R           = len(p.recThrs)</span><br><span class="line">        K           = len(p.catIds) <span class="keyword">if</span> p.useCats <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">        A           = len(p.areaRng)</span><br><span class="line">        M           = len(p.maxDets)</span><br><span class="line">        precision   = -np.ones((T,R,K,A,M)) <span class="comment"># -1 for the precision of absent categories</span></span><br><span class="line">        recall      = -np.ones((T,K,A,M))</span><br><span class="line">        scores      = -np.ones((T,R,K,A,M))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create dictionary for future indexing</span></span><br><span class="line">        _pe = self._paramsEval</span><br><span class="line">        catIds = _pe.catIds <span class="keyword">if</span> _pe.useCats <span class="keyword">else</span> [<span class="number">-1</span>]</span><br><span class="line">        setK = set(catIds)</span><br><span class="line">        setA = set(map(tuple, _pe.areaRng))</span><br><span class="line">        setM = set(_pe.maxDets)</span><br><span class="line">        setI = set(_pe.imgIds)</span><br><span class="line">        <span class="comment"># get inds to evaluate</span></span><br><span class="line">        k_list = [n <span class="keyword">for</span> n, k <span class="keyword">in</span> enumerate(p.catIds)  <span class="keyword">if</span> k <span class="keyword">in</span> setK]</span><br><span class="line">        m_list = [m <span class="keyword">for</span> n, m <span class="keyword">in</span> enumerate(p.maxDets) <span class="keyword">if</span> m <span class="keyword">in</span> setM]</span><br><span class="line">        a_list = [n <span class="keyword">for</span> n, a <span class="keyword">in</span> enumerate(map(<span class="keyword">lambda</span> x: tuple(x), p.areaRng)) <span class="keyword">if</span> a <span class="keyword">in</span> setA]</span><br><span class="line">        i_list = [n <span class="keyword">for</span> n, i <span class="keyword">in</span> enumerate(p.imgIds)  <span class="keyword">if</span> i <span class="keyword">in</span> setI]</span><br><span class="line">        I0 = len(_pe.imgIds)</span><br><span class="line">        A0 = len(_pe.areaRng)</span><br><span class="line">        <span class="comment"># retrieve E at each category, area range, and max number of detections</span></span><br><span class="line">        <span class="keyword">for</span> k, k0 <span class="keyword">in</span> enumerate(k_list):</span><br><span class="line">            Nk = k0*A0*I0</span><br><span class="line">            <span class="keyword">for</span> a, a0 <span class="keyword">in</span> enumerate(a_list):</span><br><span class="line">                Na = a0*I0</span><br><span class="line">                <span class="keyword">for</span> m, maxDet <span class="keyword">in</span> enumerate(m_list):</span><br><span class="line">                    E = [self.evalImgs[Nk + Na + i] <span class="keyword">for</span> i <span class="keyword">in</span> i_list]</span><br><span class="line">                    E = [e <span class="keyword">for</span> e <span class="keyword">in</span> E <span class="keyword">if</span> <span class="keyword">not</span> e <span class="keyword">is</span> <span class="literal">None</span>]</span><br><span class="line">                    <span class="keyword">if</span> len(E) == <span class="number">0</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    dtScores = np.concatenate([e[<span class="string">'dtScores'</span>][<span class="number">0</span>:maxDet] <span class="keyword">for</span> e <span class="keyword">in</span> E])</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># different sorting method generates slightly different results.</span></span><br><span class="line">                    <span class="comment"># mergesort is used to be consistent as Matlab implementation.</span></span><br><span class="line">                    inds = np.argsort(-dtScores, kind=<span class="string">'mergesort'</span>)</span><br><span class="line">                    dtScoresSorted = dtScores[inds]</span><br><span class="line"></span><br><span class="line">                    dtm  = np.concatenate([e[<span class="string">'dtMatches'</span>][:,<span class="number">0</span>:maxDet] <span class="keyword">for</span> e <span class="keyword">in</span> E], axis=<span class="number">1</span>)[:,inds]</span><br><span class="line">                    dtIg = np.concatenate([e[<span class="string">'dtIgnore'</span>][:,<span class="number">0</span>:maxDet]  <span class="keyword">for</span> e <span class="keyword">in</span> E], axis=<span class="number">1</span>)[:,inds]</span><br><span class="line">                    gtIg = np.concatenate([e[<span class="string">'gtIgnore'</span>] <span class="keyword">for</span> e <span class="keyword">in</span> E])</span><br><span class="line">                    npig = np.count_nonzero(gtIg==<span class="number">0</span> )</span><br><span class="line">                    <span class="keyword">if</span> npig == <span class="number">0</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    tps = np.logical_and(               dtm,  np.logical_not(dtIg) )</span><br><span class="line">                    fps = np.logical_and(np.logical_not(dtm), np.logical_not(dtIg) )</span><br><span class="line"></span><br><span class="line">                    tp_sum = np.cumsum(tps, axis=<span class="number">1</span>).astype(dtype=np.float)</span><br><span class="line">                    fp_sum = np.cumsum(fps, axis=<span class="number">1</span>).astype(dtype=np.float)</span><br><span class="line">                    <span class="keyword">for</span> t, (tp, fp) <span class="keyword">in</span> enumerate(zip(tp_sum, fp_sum)):</span><br><span class="line">                        tp = np.array(tp)</span><br><span class="line">                        fp = np.array(fp)</span><br><span class="line">                        nd = len(tp)</span><br><span class="line">                        rc = tp / npig</span><br><span class="line">                        pr = tp / (fp+tp+np.spacing(<span class="number">1</span>))</span><br><span class="line">                        q  = np.zeros((R,))</span><br><span class="line">                        ss = np.zeros((R,))</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> nd:</span><br><span class="line">                            recall[t,k,a,m] = rc[<span class="number">-1</span>]</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            recall[t,k,a,m] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment"># numpy is slow without cython optimization for accessing elements</span></span><br><span class="line">                        <span class="comment"># use python array gets significant speed improvement</span></span><br><span class="line">                        pr = pr.tolist(); q = q.tolist()</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span> i <span class="keyword">in</span> range(nd<span class="number">-1</span>, <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">                            <span class="keyword">if</span> pr[i] &gt; pr[i<span class="number">-1</span>]:</span><br><span class="line">                                pr[i<span class="number">-1</span>] = pr[i]</span><br><span class="line"></span><br><span class="line">                        inds = np.searchsorted(rc, p.recThrs, side=<span class="string">'left'</span>)</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            <span class="keyword">for</span> ri, pi <span class="keyword">in</span> enumerate(inds):</span><br><span class="line">                                q[ri] = pr[pi]</span><br><span class="line">                                ss[ri] = dtScoresSorted[pi]</span><br><span class="line">                        <span class="keyword">except</span>:</span><br><span class="line">                            <span class="keyword">pass</span></span><br><span class="line">                        precision[t,:,k,a,m] = np.array(q)</span><br><span class="line">                        scores[t,:,k,a,m] = np.array(ss)</span><br><span class="line">        self.eval = &#123;</span><br><span class="line">            <span class="string">'params'</span>: p,</span><br><span class="line">            <span class="string">'counts'</span>: [T, R, K, A, M],</span><br><span class="line">            <span class="string">'date'</span>: datetime.datetime.now().strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>),</span><br><span class="line">            <span class="string">'precision'</span>: precision,</span><br><span class="line">            <span class="string">'recall'</span>:   recall,</span><br><span class="line">            <span class="string">'scores'</span>: scores,</span><br><span class="line">        &#125;</span><br><span class="line">        toc = time.time()</span><br><span class="line">        print(<span class="string">'DONE (t=&#123;:0.2f&#125;s).'</span>.format( toc-tic))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">summarize</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        Compute and display summary metrics for evaluation results.</span></span><br><span class="line"><span class="string">        Note this functin can *only* be applied on the default parameter setting</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_summarize</span><span class="params">( ap=<span class="number">1</span>, iouThr=None, areaRng=<span class="string">'all'</span>, maxDets=<span class="number">100</span> )</span>:</span></span><br><span class="line">            p = self.params</span><br><span class="line">            iStr = <span class="string">' &#123;:&lt;18&#125; &#123;&#125; @[ IoU=&#123;:&lt;9&#125; | area=&#123;:&gt;6s&#125; | maxDets=&#123;:&gt;3d&#125; ] = &#123;:0.3f&#125;'</span></span><br><span class="line">            titleStr = <span class="string">'Average Precision'</span> <span class="keyword">if</span> ap == <span class="number">1</span> <span class="keyword">else</span> <span class="string">'Average Recall'</span></span><br><span class="line">            typeStr = <span class="string">'(AP)'</span> <span class="keyword">if</span> ap==<span class="number">1</span> <span class="keyword">else</span> <span class="string">'(AR)'</span></span><br><span class="line">            iouStr = <span class="string">'&#123;:0.2f&#125;:&#123;:0.2f&#125;'</span>.format(p.iouThrs[<span class="number">0</span>], p.iouThrs[<span class="number">-1</span>]) \</span><br><span class="line">                <span class="keyword">if</span> iouThr <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="string">'&#123;:0.2f&#125;'</span>.format(iouThr)</span><br><span class="line"></span><br><span class="line">            aind = [i <span class="keyword">for</span> i, aRng <span class="keyword">in</span> enumerate(p.areaRngLbl) <span class="keyword">if</span> aRng == areaRng]</span><br><span class="line">            mind = [i <span class="keyword">for</span> i, mDet <span class="keyword">in</span> enumerate(p.maxDets) <span class="keyword">if</span> mDet == maxDets]</span><br><span class="line">            <span class="keyword">if</span> ap == <span class="number">1</span>:</span><br><span class="line">                <span class="comment"># dimension of precision: [TxRxKxAxM]</span></span><br><span class="line">                s = self.eval[<span class="string">'precision'</span>]</span><br><span class="line">                <span class="comment"># IoU</span></span><br><span class="line">                <span class="keyword">if</span> iouThr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    t = np.where(iouThr == p.iouThrs)[<span class="number">0</span>]</span><br><span class="line">                    s = s[t]</span><br><span class="line">                s = s[:,:,:,aind,mind]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># dimension of recall: [TxKxAxM]</span></span><br><span class="line">                s = self.eval[<span class="string">'recall'</span>]</span><br><span class="line">                <span class="keyword">if</span> iouThr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    t = np.where(iouThr == p.iouThrs)[<span class="number">0</span>]</span><br><span class="line">                    s = s[t]</span><br><span class="line">                s = s[:,:,aind,mind]</span><br><span class="line">            <span class="keyword">if</span> len(s[s&gt;<span class="number">-1</span>])==<span class="number">0</span>:</span><br><span class="line">                mean_s = <span class="number">-1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                mean_s = np.mean(s[s&gt;<span class="number">-1</span>])</span><br><span class="line">            print(iStr.format(titleStr, typeStr, iouStr, areaRng, maxDets, mean_s))</span><br><span class="line">            <span class="keyword">return</span> mean_s</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_summarizeDets</span><span class="params">()</span>:</span></span><br><span class="line">            stats = np.zeros((<span class="number">12</span>,))</span><br><span class="line">            stats[<span class="number">0</span>] = _summarize(<span class="number">1</span>)</span><br><span class="line">            stats[<span class="number">1</span>] = _summarize(<span class="number">1</span>, iouThr=<span class="number">.5</span>, maxDets=self.params.maxDets[<span class="number">2</span>])</span><br><span class="line">            stats[<span class="number">2</span>] = _summarize(<span class="number">1</span>, iouThr=<span class="number">.75</span>, maxDets=self.params.maxDets[<span class="number">2</span>])</span><br><span class="line">            stats[<span class="number">3</span>] = _summarize(<span class="number">1</span>, areaRng=<span class="string">'small'</span>, maxDets=self.params.maxDets[<span class="number">2</span>])</span><br><span class="line">            stats[<span class="number">4</span>] = _summarize(<span class="number">1</span>, areaRng=<span class="string">'medium'</span>, maxDets=self.params.maxDets[<span class="number">2</span>])</span><br><span class="line">            stats[<span class="number">5</span>] = _summarize(<span class="number">1</span>, areaRng=<span class="string">'large'</span>, maxDets=self.params.maxDets[<span class="number">2</span>])</span><br><span class="line">            stats[<span class="number">6</span>] = _summarize(<span class="number">0</span>, maxDets=self.params.maxDets[<span class="number">0</span>])</span><br><span class="line">            stats[<span class="number">7</span>] = _summarize(<span class="number">0</span>, maxDets=self.params.maxDets[<span class="number">1</span>])</span><br><span class="line">            stats[<span class="number">8</span>] = _summarize(<span class="number">0</span>, maxDets=self.params.maxDets[<span class="number">2</span>])</span><br><span class="line">            stats[<span class="number">9</span>] = _summarize(<span class="number">0</span>, areaRng=<span class="string">'small'</span>, maxDets=self.params.maxDets[<span class="number">2</span>])</span><br><span class="line">            stats[<span class="number">10</span>] = _summarize(<span class="number">0</span>, areaRng=<span class="string">'medium'</span>, maxDets=self.params.maxDets[<span class="number">2</span>])</span><br><span class="line">            stats[<span class="number">11</span>] = _summarize(<span class="number">0</span>, areaRng=<span class="string">'large'</span>, maxDets=self.params.maxDets[<span class="number">2</span>])</span><br><span class="line">            <span class="keyword">return</span> stats</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_summarizeKps</span><span class="params">()</span>:</span></span><br><span class="line">            stats = np.zeros((<span class="number">10</span>,))</span><br><span class="line">            stats[<span class="number">0</span>] = _summarize(<span class="number">1</span>, maxDets=<span class="number">20</span>)</span><br><span class="line">            stats[<span class="number">1</span>] = _summarize(<span class="number">1</span>, maxDets=<span class="number">20</span>, iouThr=<span class="number">.5</span>)</span><br><span class="line">            stats[<span class="number">2</span>] = _summarize(<span class="number">1</span>, maxDets=<span class="number">20</span>, iouThr=<span class="number">.75</span>)</span><br><span class="line">            stats[<span class="number">3</span>] = _summarize(<span class="number">1</span>, maxDets=<span class="number">20</span>, areaRng=<span class="string">'medium'</span>)</span><br><span class="line">            stats[<span class="number">4</span>] = _summarize(<span class="number">1</span>, maxDets=<span class="number">20</span>, areaRng=<span class="string">'large'</span>)</span><br><span class="line">            stats[<span class="number">5</span>] = _summarize(<span class="number">0</span>, maxDets=<span class="number">20</span>)</span><br><span class="line">            stats[<span class="number">6</span>] = _summarize(<span class="number">0</span>, maxDets=<span class="number">20</span>, iouThr=<span class="number">.5</span>)</span><br><span class="line">            stats[<span class="number">7</span>] = _summarize(<span class="number">0</span>, maxDets=<span class="number">20</span>, iouThr=<span class="number">.75</span>)</span><br><span class="line">            stats[<span class="number">8</span>] = _summarize(<span class="number">0</span>, maxDets=<span class="number">20</span>, areaRng=<span class="string">'medium'</span>)</span><br><span class="line">            stats[<span class="number">9</span>] = _summarize(<span class="number">0</span>, maxDets=<span class="number">20</span>, areaRng=<span class="string">'large'</span>)</span><br><span class="line">            <span class="keyword">return</span> stats</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.eval:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Please run accumulate() first'</span>)</span><br><span class="line">        iouType = self.params.iouType</span><br><span class="line">        <span class="keyword">if</span> iouType == <span class="string">'segm'</span> <span class="keyword">or</span> iouType == <span class="string">'bbox'</span>:</span><br><span class="line">            summarize = _summarizeDets</span><br><span class="line">        <span class="keyword">elif</span> iouType == <span class="string">'keypoints'</span>:</span><br><span class="line">            summarize = _summarizeKps</span><br><span class="line">        self.stats = summarize()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.summarize()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Params</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Params for coco evaluation api</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setDetParams</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.imgIds = []</span><br><span class="line">        self.catIds = []</span><br><span class="line">        <span class="comment"># np.arange causes trouble.  the data point on arange is slightly larger than the true value</span></span><br><span class="line">        self.iouThrs = np.linspace(<span class="number">.5</span>, <span class="number">0.95</span>, np.round((<span class="number">0.95</span> - <span class="number">.5</span>) / <span class="number">.05</span>) + <span class="number">1</span>, endpoint=<span class="literal">True</span>)</span><br><span class="line">        self.recThrs = np.linspace(<span class="number">.0</span>, <span class="number">1.00</span>, np.round((<span class="number">1.00</span> - <span class="number">.0</span>) / <span class="number">.01</span>) + <span class="number">1</span>, endpoint=<span class="literal">True</span>)</span><br><span class="line">        self.maxDets = [<span class="number">1</span>, <span class="number">10</span>, <span class="number">100</span>]</span><br><span class="line">        self.areaRng = [[<span class="number">0</span> ** <span class="number">2</span>, <span class="number">1e5</span> ** <span class="number">2</span>], [<span class="number">0</span> ** <span class="number">2</span>, <span class="number">32</span> ** <span class="number">2</span>], [<span class="number">32</span> ** <span class="number">2</span>, <span class="number">96</span> ** <span class="number">2</span>], [<span class="number">96</span> ** <span class="number">2</span>, <span class="number">1e5</span> ** <span class="number">2</span>]]</span><br><span class="line">        self.areaRngLbl = [<span class="string">'all'</span>, <span class="string">'small'</span>, <span class="string">'medium'</span>, <span class="string">'large'</span>]</span><br><span class="line">        self.useCats = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setKpParams</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.imgIds = []</span><br><span class="line">        self.catIds = []</span><br><span class="line">        <span class="comment"># np.arange causes trouble.  the data point on arange is slightly larger than the true value</span></span><br><span class="line">        self.iouThrs = np.linspace(<span class="number">.5</span>, <span class="number">0.95</span>, np.round((<span class="number">0.95</span> - <span class="number">.5</span>) / <span class="number">.05</span>) + <span class="number">1</span>, endpoint=<span class="literal">True</span>)</span><br><span class="line">        self.recThrs = np.linspace(<span class="number">.0</span>, <span class="number">1.00</span>, np.round((<span class="number">1.00</span> - <span class="number">.0</span>) / <span class="number">.01</span>) + <span class="number">1</span>, endpoint=<span class="literal">True</span>)</span><br><span class="line">        self.maxDets = [<span class="number">20</span>]</span><br><span class="line">        self.areaRng = [[<span class="number">0</span> ** <span class="number">2</span>, <span class="number">1e5</span> ** <span class="number">2</span>], [<span class="number">32</span> ** <span class="number">2</span>, <span class="number">96</span> ** <span class="number">2</span>], [<span class="number">96</span> ** <span class="number">2</span>, <span class="number">1e5</span> ** <span class="number">2</span>]]</span><br><span class="line">        self.areaRngLbl = [<span class="string">'all'</span>, <span class="string">'medium'</span>, <span class="string">'large'</span>]</span><br><span class="line">        self.useCats = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, iouType=<span class="string">'segm'</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> iouType == <span class="string">'segm'</span> <span class="keyword">or</span> iouType == <span class="string">'bbox'</span>:</span><br><span class="line">            self.setDetParams()</span><br><span class="line">        <span class="keyword">elif</span> iouType == <span class="string">'keypoints'</span>:</span><br><span class="line">            self.setKpParams()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'iouType not supported'</span>)</span><br><span class="line">        self.iouType = iouType</span><br><span class="line">        <span class="comment"># useSegm is deprecated</span></span><br><span class="line">        self.useSegm = <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h2 id="3-评测指标示例-pycocoEvalDemo"><a href="#3-评测指标示例-pycocoEvalDemo" class="headerlink" title="3. 评测指标示例 - pycocoEvalDemo"></a>3. 评测指标示例 - pycocoEvalDemo</h2><blockquote>
<p><a href="https://github.com/cocodataset/cocoapi/blob/master/PythonAPI/pycocoEvalDemo.ipynb" target="_blank" rel="noopener">PythonAPI/pycocoEvalDemo.ipynb</a></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> pycocotools.coco <span class="keyword">import</span> COCO</span><br><span class="line"><span class="keyword">from</span> pycocotools.cocoeval <span class="keyword">import</span> COCOeval</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> skimage.io <span class="keyword">as</span> io</span><br><span class="line"><span class="keyword">import</span> pylab</span><br><span class="line">pylab.rcParams[<span class="string">'figure.figsize'</span>] = (<span class="number">10.0</span>, <span class="number">8.0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">annType = [<span class="string">'segm'</span>,<span class="string">'bbox'</span>,<span class="string">'keypoints'</span>]</span><br><span class="line">annType = annType[<span class="number">1</span>]      <span class="comment"># specify type here - bbox 类型</span></span><br><span class="line">prefix = <span class="string">'person_keypoints'</span> <span class="keyword">if</span> annType==<span class="string">'keypoints'</span> <span class="keyword">else</span> <span class="string">'instances'</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'Running demo for *%s* results.'</span>%(annType)</span><br><span class="line"></span><br><span class="line"><span class="comment">#initialize COCO ground truth api</span></span><br><span class="line">dataDir=<span class="string">'../'</span></span><br><span class="line">dataType=<span class="string">'val2014'</span></span><br><span class="line">annFile = <span class="string">'%s/annotations/%s_%s.json'</span>%(dataDir,prefix,dataType)</span><br><span class="line">cocoGt=COCO(annFile)</span><br><span class="line"></span><br><span class="line"><span class="comment">#initialize COCO detections api</span></span><br><span class="line">resFile=<span class="string">'%s/results/%s_%s_fake%s100_results.json'</span></span><br><span class="line">resFile = resFile%(dataDir, prefix, dataType, annType)</span><br><span class="line">cocoDt=cocoGt.loadRes(resFile)</span><br><span class="line"></span><br><span class="line">imgIds=sorted(cocoGt.getImgIds())</span><br><span class="line">imgIds=imgIds[<span class="number">0</span>:<span class="number">100</span>]</span><br><span class="line">imgId = imgIds[np.random.randint(<span class="number">100</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># running evaluation</span></span><br><span class="line">cocoEval = COCOeval(cocoGt,cocoDt,annType)</span><br><span class="line">cocoEval.params.imgIds  = imgIds</span><br><span class="line">cocoEval.evaluate()</span><br><span class="line">cocoEval.accumulate()</span><br><span class="line">cocoEval.summarize()</span><br></pre></td></tr></table></figure>

<p>输出结果如：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Running per image evaluation...      </span><br><span class="line">DONE (t=<span class="number">0.46</span>s).</span><br><span class="line">Accumulating evaluation results...   </span><br><span class="line">DONE (t=<span class="number">0.38</span>s).</span><br><span class="line"> Average Precision  (AP) @[ IoU=<span class="number">0.50</span>:<span class="number">0.95</span> | area=   all | maxDets=<span class="number">100</span> ] = <span class="number">0.505</span></span><br><span class="line"> Average Precision  (AP) @[ IoU=<span class="number">0.50</span>      | area=   all | maxDets=<span class="number">100</span> ] = <span class="number">0.697</span></span><br><span class="line"> Average Precision  (AP) @[ IoU=<span class="number">0.75</span>      | area=   all | maxDets=<span class="number">100</span> ] = <span class="number">0.573</span></span><br><span class="line"> Average Precision  (AP) @[ IoU=<span class="number">0.50</span>:<span class="number">0.95</span> | area= small | maxDets=<span class="number">100</span> ] = <span class="number">0.586</span></span><br><span class="line"> Average Precision  (AP) @[ IoU=<span class="number">0.50</span>:<span class="number">0.95</span> | area=medium | maxDets=<span class="number">100</span> ] = <span class="number">0.519</span></span><br><span class="line"> Average Precision  (AP) @[ IoU=<span class="number">0.50</span>:<span class="number">0.95</span> | area= large | maxDets=<span class="number">100</span> ] = <span class="number">0.501</span></span><br><span class="line"> Average Recall     (AR) @[ IoU=<span class="number">0.50</span>:<span class="number">0.95</span> | area=   all | maxDets=  <span class="number">1</span> ] = <span class="number">0.387</span></span><br><span class="line"> Average Recall     (AR) @[ IoU=<span class="number">0.50</span>:<span class="number">0.95</span> | area=   all | maxDets= <span class="number">10</span> ] = <span class="number">0.594</span></span><br><span class="line"> Average Recall     (AR) @[ IoU=<span class="number">0.50</span>:<span class="number">0.95</span> | area=   all | maxDets=<span class="number">100</span> ] = <span class="number">0.595</span></span><br><span class="line"> Average Recall     (AR) @[ IoU=<span class="number">0.50</span>:<span class="number">0.95</span> | area= small | maxDets=<span class="number">100</span> ] = <span class="number">0.640</span></span><br><span class="line"> Average Recall     (AR) @[ IoU=<span class="number">0.50</span>:<span class="number">0.95</span> | area=medium | maxDets=<span class="number">100</span> ] = <span class="number">0.566</span></span><br><span class="line"> Average Recall     (AR) @[ IoU=<span class="number">0.50</span>:<span class="number">0.95</span> | area= large | maxDets=<span class="number">100</span> ] = <span class="number">0.564</span></span><br></pre></td></tr></table></figure>

<h2 id="4-COCO-类"><a href="#4-COCO-类" class="headerlink" title="4. COCO 类"></a>4. COCO 类</h2><blockquote>
<p><a href="https://github.com/cocodataset/cocoapi/blob/master/PythonAPI/pycocotools/coco.py" target="_blank" rel="noopener">PythonAPI/pycocotools/coco.py</a></p>
</blockquote>
<p>COCO 格式数据集的类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br></pre></td><td class="code"><pre><span class="line">__author__ = <span class="string">'tylin'</span></span><br><span class="line">__version__ = <span class="string">'2.0'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># API用于将 COCO 标注数据集 annotations 直接加载到 Python 字典.</span></span><br><span class="line"><span class="comment"># 还提供了其它辅助函数.</span></span><br><span class="line"><span class="comment"># 该 API 同时支持 *instance* 和 *caption* 的标注数据.</span></span><br><span class="line"><span class="comment"># 但，并未定义 *caption* 的全部函数(如，categories 暂未定义).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># API 中包含的函数如下：</span></span><br><span class="line"><span class="comment"># 其中，"ann"=annotation, "cat"=category, and "img"=image.</span></span><br><span class="line"><span class="comment">#  COCO       - COCO api class that loads COCO annotation file and prepare data structures.</span></span><br><span class="line"><span class="comment">#  decodeMask - Decode binary mask M encoded via run-length encoding.</span></span><br><span class="line"><span class="comment">#  encodeMask - Encode binary mask M using run-length encoding.</span></span><br><span class="line"><span class="comment">#  getAnnIds  - Get ann ids that satisfy given filter conditions.</span></span><br><span class="line"><span class="comment">#  getCatIds  - Get cat ids that satisfy given filter conditions.</span></span><br><span class="line"><span class="comment">#  getImgIds  - Get img ids that satisfy given filter conditions.</span></span><br><span class="line"><span class="comment">#  loadAnns   - Load anns with the specified ids.</span></span><br><span class="line"><span class="comment">#  loadCats   - Load cats with the specified ids.</span></span><br><span class="line"><span class="comment">#  loadImgs   - Load imgs with the specified ids.</span></span><br><span class="line"><span class="comment">#  annToMask  - Convert segmentation in an annotation to binary mask.</span></span><br><span class="line"><span class="comment">#  showAnns   - Display the specified annotations.</span></span><br><span class="line"><span class="comment">#  loadRes    - Load algorithm results and create API for accessing them.</span></span><br><span class="line"><span class="comment">#  download   - Download COCO images from mscoco.org server.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> matplotlib.collections <span class="keyword">import</span> PatchCollection</span><br><span class="line"><span class="keyword">from</span> matplotlib.patches <span class="keyword">import</span> Polygon</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> mask <span class="keyword">as</span> maskUtils</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">PYTHON_VERSION = sys.version_info[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">if</span> PYTHON_VERSION == <span class="number">2</span>:</span><br><span class="line">    <span class="keyword">from</span> urllib <span class="keyword">import</span> urlretrieve</span><br><span class="line"><span class="keyword">elif</span> PYTHON_VERSION == <span class="number">3</span>:</span><br><span class="line">    <span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlretrieve</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_isArrayLike</span><span class="params">(obj)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hasattr(obj, <span class="string">'__iter__'</span>) <span class="keyword">and</span> hasattr(obj, <span class="string">'__len__'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">COCO</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, annotation_file=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Constructor of Microsoft COCO helper class for reading and visualizing annotations.</span></span><br><span class="line"><span class="string">        :param annotation_file (str): location of annotation file</span></span><br><span class="line"><span class="string">        :param image_folder (str): location to the folder that hosts images.</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># load dataset</span></span><br><span class="line">        self.dataset,self.anns,self.cats,self.imgs = dict(),dict(),dict(),dict()</span><br><span class="line">        self.imgToAnns, self.catToImgs = defaultdict(list), defaultdict(list)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> annotation_file == <span class="literal">None</span>:</span><br><span class="line">            print(<span class="string">'loading annotations into memory...'</span>)</span><br><span class="line">            tic = time.time()</span><br><span class="line">            dataset = json.load(open(annotation_file, <span class="string">'r'</span>))</span><br><span class="line">            <span class="keyword">assert</span> type(dataset)==dict, <span class="string">'annotation file format &#123;&#125; not supported'</span>.format(type(dataset))</span><br><span class="line">            print(<span class="string">'Done (t=&#123;:0.2f&#125;s)'</span>.format(time.time()- tic))</span><br><span class="line">            self.dataset = dataset</span><br><span class="line">            self.createIndex()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createIndex</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># create index</span></span><br><span class="line">        print(<span class="string">'creating index...'</span>)</span><br><span class="line">        anns, cats, imgs = &#123;&#125;, &#123;&#125;, &#123;&#125;</span><br><span class="line">        imgToAnns,catToImgs = defaultdict(list),defaultdict(list)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'annotations'</span> <span class="keyword">in</span> self.dataset:</span><br><span class="line">            <span class="keyword">for</span> ann <span class="keyword">in</span> self.dataset[<span class="string">'annotations'</span>]:</span><br><span class="line">                imgToAnns[ann[<span class="string">'image_id'</span>]].append(ann)</span><br><span class="line">                anns[ann[<span class="string">'id'</span>]] = ann</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'images'</span> <span class="keyword">in</span> self.dataset:</span><br><span class="line">            <span class="keyword">for</span> img <span class="keyword">in</span> self.dataset[<span class="string">'images'</span>]:</span><br><span class="line">                imgs[img[<span class="string">'id'</span>]] = img</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'categories'</span> <span class="keyword">in</span> self.dataset:</span><br><span class="line">            <span class="keyword">for</span> cat <span class="keyword">in</span> self.dataset[<span class="string">'categories'</span>]:</span><br><span class="line">                cats[cat[<span class="string">'id'</span>]] = cat</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'annotations'</span> <span class="keyword">in</span> self.dataset <span class="keyword">and</span> <span class="string">'categories'</span> <span class="keyword">in</span> self.dataset:</span><br><span class="line">            <span class="keyword">for</span> ann <span class="keyword">in</span> self.dataset[<span class="string">'annotations'</span>]:</span><br><span class="line">                catToImgs[ann[<span class="string">'category_id'</span>]].append(ann[<span class="string">'image_id'</span>])</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'index created!'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create class members</span></span><br><span class="line">        self.anns = anns</span><br><span class="line">        self.imgToAnns = imgToAnns</span><br><span class="line">        self.catToImgs = catToImgs</span><br><span class="line">        self.imgs = imgs</span><br><span class="line">        self.cats = cats</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">info</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Print information about the annotation file.</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> self.dataset[<span class="string">'info'</span>].items():</span><br><span class="line">            print(<span class="string">'&#123;&#125;: &#123;&#125;'</span>.format(key, value))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getAnnIds</span><span class="params">(self, imgIds=[], catIds=[], areaRng=[], iscrowd=None)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Get ann ids that satisfy given filter conditions. default skips that filter</span></span><br><span class="line"><span class="string">        :param imgIds  (int array)     : get anns for given imgs</span></span><br><span class="line"><span class="string">               catIds  (int array)     : get anns for given cats</span></span><br><span class="line"><span class="string">               areaRng (float array)   : get anns for given area range (e.g. [0 inf])</span></span><br><span class="line"><span class="string">               iscrowd (boolean)       : get anns for given crowd label (False or True)</span></span><br><span class="line"><span class="string">        :return: ids (int array)       : integer array of ann ids</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        imgIds = imgIds <span class="keyword">if</span> _isArrayLike(imgIds) <span class="keyword">else</span> [imgIds]</span><br><span class="line">        catIds = catIds <span class="keyword">if</span> _isArrayLike(catIds) <span class="keyword">else</span> [catIds]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> len(imgIds) == len(catIds) == len(areaRng) == <span class="number">0</span>:</span><br><span class="line">            anns = self.dataset[<span class="string">'annotations'</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> len(imgIds) == <span class="number">0</span>:</span><br><span class="line">                lists = [self.imgToAnns[imgId] <span class="keyword">for</span> imgId <span class="keyword">in</span> imgIds <span class="keyword">if</span> imgId <span class="keyword">in</span> self.imgToAnns]</span><br><span class="line">                anns = list(itertools.chain.from_iterable(lists))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                anns = self.dataset[<span class="string">'annotations'</span>]</span><br><span class="line">            anns = anns <span class="keyword">if</span> len(catIds)  == <span class="number">0</span> <span class="keyword">else</span> [ann <span class="keyword">for</span> ann <span class="keyword">in</span> anns <span class="keyword">if</span> ann[<span class="string">'category_id'</span>] <span class="keyword">in</span> catIds]</span><br><span class="line">            anns = anns <span class="keyword">if</span> len(areaRng) == <span class="number">0</span> <span class="keyword">else</span> [ann <span class="keyword">for</span> ann <span class="keyword">in</span> anns <span class="keyword">if</span> ann[<span class="string">'area'</span>] &gt; areaRng[<span class="number">0</span>] <span class="keyword">and</span> ann[<span class="string">'area'</span>] &lt; areaRng[<span class="number">1</span>]]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> iscrowd == <span class="literal">None</span>:</span><br><span class="line">            ids = [ann[<span class="string">'id'</span>] <span class="keyword">for</span> ann <span class="keyword">in</span> anns <span class="keyword">if</span> ann[<span class="string">'iscrowd'</span>] == iscrowd]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ids = [ann[<span class="string">'id'</span>] <span class="keyword">for</span> ann <span class="keyword">in</span> anns]</span><br><span class="line">        <span class="keyword">return</span> ids</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getCatIds</span><span class="params">(self, catNms=[], supNms=[], catIds=[])</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        filtering parameters. default skips that filter.</span></span><br><span class="line"><span class="string">        :param catNms (str array)  : get cats for given cat names</span></span><br><span class="line"><span class="string">        :param supNms (str array)  : get cats for given supercategory names</span></span><br><span class="line"><span class="string">        :param catIds (int array)  : get cats for given cat ids</span></span><br><span class="line"><span class="string">        :return: ids (int array)   : integer array of cat ids</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        catNms = catNms <span class="keyword">if</span> _isArrayLike(catNms) <span class="keyword">else</span> [catNms]</span><br><span class="line">        supNms = supNms <span class="keyword">if</span> _isArrayLike(supNms) <span class="keyword">else</span> [supNms]</span><br><span class="line">        catIds = catIds <span class="keyword">if</span> _isArrayLike(catIds) <span class="keyword">else</span> [catIds]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> len(catNms) == len(supNms) == len(catIds) == <span class="number">0</span>:</span><br><span class="line">            cats = self.dataset[<span class="string">'categories'</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cats = self.dataset[<span class="string">'categories'</span>]</span><br><span class="line">            cats = cats <span class="keyword">if</span> len(catNms) == <span class="number">0</span> <span class="keyword">else</span> [cat <span class="keyword">for</span> cat <span class="keyword">in</span> cats <span class="keyword">if</span> cat[<span class="string">'name'</span>]          <span class="keyword">in</span> catNms]</span><br><span class="line">            cats = cats <span class="keyword">if</span> len(supNms) == <span class="number">0</span> <span class="keyword">else</span> [cat <span class="keyword">for</span> cat <span class="keyword">in</span> cats <span class="keyword">if</span> cat[<span class="string">'supercategory'</span>] <span class="keyword">in</span> supNms]</span><br><span class="line">            cats = cats <span class="keyword">if</span> len(catIds) == <span class="number">0</span> <span class="keyword">else</span> [cat <span class="keyword">for</span> cat <span class="keyword">in</span> cats <span class="keyword">if</span> cat[<span class="string">'id'</span>]            <span class="keyword">in</span> catIds]</span><br><span class="line">        ids = [cat[<span class="string">'id'</span>] <span class="keyword">for</span> cat <span class="keyword">in</span> cats]</span><br><span class="line">        <span class="keyword">return</span> ids</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getImgIds</span><span class="params">(self, imgIds=[], catIds=[])</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        Get img ids that satisfy given filter conditions.</span></span><br><span class="line"><span class="string">        :param imgIds (int array) : get imgs for given ids</span></span><br><span class="line"><span class="string">        :param catIds (int array) : get imgs with all given cats</span></span><br><span class="line"><span class="string">        :return: ids (int array)  : integer array of img ids</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        imgIds = imgIds <span class="keyword">if</span> _isArrayLike(imgIds) <span class="keyword">else</span> [imgIds]</span><br><span class="line">        catIds = catIds <span class="keyword">if</span> _isArrayLike(catIds) <span class="keyword">else</span> [catIds]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> len(imgIds) == len(catIds) == <span class="number">0</span>:</span><br><span class="line">            ids = self.imgs.keys()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ids = set(imgIds)</span><br><span class="line">            <span class="keyword">for</span> i, catId <span class="keyword">in</span> enumerate(catIds):</span><br><span class="line">                <span class="keyword">if</span> i == <span class="number">0</span> <span class="keyword">and</span> len(ids) == <span class="number">0</span>:</span><br><span class="line">                    ids = set(self.catToImgs[catId])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    ids &amp;= set(self.catToImgs[catId])</span><br><span class="line">        <span class="keyword">return</span> list(ids)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loadAnns</span><span class="params">(self, ids=[])</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Load anns with the specified ids.</span></span><br><span class="line"><span class="string">        :param ids (int array)       : integer ids specifying anns</span></span><br><span class="line"><span class="string">        :return: anns (object array) : loaded ann objects</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> _isArrayLike(ids):</span><br><span class="line">            <span class="keyword">return</span> [self.anns[id] <span class="keyword">for</span> id <span class="keyword">in</span> ids]</span><br><span class="line">        <span class="keyword">elif</span> type(ids) == int:</span><br><span class="line">            <span class="keyword">return</span> [self.anns[ids]]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loadCats</span><span class="params">(self, ids=[])</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Load cats with the specified ids.</span></span><br><span class="line"><span class="string">        :param ids (int array)       : integer ids specifying cats</span></span><br><span class="line"><span class="string">        :return: cats (object array) : loaded cat objects</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> _isArrayLike(ids):</span><br><span class="line">            <span class="keyword">return</span> [self.cats[id] <span class="keyword">for</span> id <span class="keyword">in</span> ids]</span><br><span class="line">        <span class="keyword">elif</span> type(ids) == int:</span><br><span class="line">            <span class="keyword">return</span> [self.cats[ids]]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loadImgs</span><span class="params">(self, ids=[])</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Load anns with the specified ids.</span></span><br><span class="line"><span class="string">        :param ids (int array)       : integer ids specifying img</span></span><br><span class="line"><span class="string">        :return: imgs (object array) : loaded img objects</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> _isArrayLike(ids):</span><br><span class="line">            <span class="keyword">return</span> [self.imgs[id] <span class="keyword">for</span> id <span class="keyword">in</span> ids]</span><br><span class="line">        <span class="keyword">elif</span> type(ids) == int:</span><br><span class="line">            <span class="keyword">return</span> [self.imgs[ids]]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">showAnns</span><span class="params">(self, anns)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Display the specified annotations.</span></span><br><span class="line"><span class="string">        :param anns (array of object): annotations to display</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> len(anns) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'segmentation'</span> <span class="keyword">in</span> anns[<span class="number">0</span>] <span class="keyword">or</span> <span class="string">'keypoints'</span> <span class="keyword">in</span> anns[<span class="number">0</span>]:</span><br><span class="line">            datasetType = <span class="string">'instances'</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">'caption'</span> <span class="keyword">in</span> anns[<span class="number">0</span>]:</span><br><span class="line">            datasetType = <span class="string">'captions'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'datasetType not supported'</span>)</span><br><span class="line">        <span class="keyword">if</span> datasetType == <span class="string">'instances'</span>:</span><br><span class="line">            ax = plt.gca()</span><br><span class="line">            ax.set_autoscale_on(<span class="literal">False</span>)</span><br><span class="line">            polygons = []</span><br><span class="line">            color = []</span><br><span class="line">            <span class="keyword">for</span> ann <span class="keyword">in</span> anns:</span><br><span class="line">                c = (np.random.random((<span class="number">1</span>, <span class="number">3</span>))*<span class="number">0.6</span>+<span class="number">0.4</span>).tolist()[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> <span class="string">'segmentation'</span> <span class="keyword">in</span> ann:</span><br><span class="line">                    <span class="keyword">if</span> type(ann[<span class="string">'segmentation'</span>]) == list:</span><br><span class="line">                        <span class="comment"># polygon</span></span><br><span class="line">                        <span class="keyword">for</span> seg <span class="keyword">in</span> ann[<span class="string">'segmentation'</span>]:</span><br><span class="line">                            poly = np.array(seg).reshape((int(len(seg)/<span class="number">2</span>), <span class="number">2</span>))</span><br><span class="line">                            polygons.append(Polygon(poly))</span><br><span class="line">                            color.append(c)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="comment"># mask</span></span><br><span class="line">                        t = self.imgs[ann[<span class="string">'image_id'</span>]]</span><br><span class="line">                        <span class="keyword">if</span> type(ann[<span class="string">'segmentation'</span>][<span class="string">'counts'</span>]) == list:</span><br><span class="line">                            rle = maskUtils.frPyObjects([ann[<span class="string">'segmentation'</span>]], t[<span class="string">'height'</span>], t[<span class="string">'width'</span>])</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            rle = [ann[<span class="string">'segmentation'</span>]]</span><br><span class="line">                        m = maskUtils.decode(rle)</span><br><span class="line">                        img = np.ones( (m.shape[<span class="number">0</span>], m.shape[<span class="number">1</span>], <span class="number">3</span>) )</span><br><span class="line">                        <span class="keyword">if</span> ann[<span class="string">'iscrowd'</span>] == <span class="number">1</span>:</span><br><span class="line">                            color_mask = np.array([<span class="number">2.0</span>,<span class="number">166.0</span>,<span class="number">101.0</span>])/<span class="number">255</span></span><br><span class="line">                        <span class="keyword">if</span> ann[<span class="string">'iscrowd'</span>] == <span class="number">0</span>:</span><br><span class="line">                            color_mask = np.random.random((<span class="number">1</span>, <span class="number">3</span>)).tolist()[<span class="number">0</span>]</span><br><span class="line">                        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">                            img[:,:,i] = color_mask[i]</span><br><span class="line">                        ax.imshow(np.dstack( (img, m*<span class="number">0.5</span>) ))</span><br><span class="line">                <span class="keyword">if</span> <span class="string">'keypoints'</span> <span class="keyword">in</span> ann <span class="keyword">and</span> type(ann[<span class="string">'keypoints'</span>]) == list:</span><br><span class="line">                    <span class="comment"># turn skeleton into zero-based index</span></span><br><span class="line">                    sks = np.array(self.loadCats(ann[<span class="string">'category_id'</span>])[<span class="number">0</span>][<span class="string">'skeleton'</span>])<span class="number">-1</span></span><br><span class="line">                    kp = np.array(ann[<span class="string">'keypoints'</span>])</span><br><span class="line">                    x = kp[<span class="number">0</span>::<span class="number">3</span>]</span><br><span class="line">                    y = kp[<span class="number">1</span>::<span class="number">3</span>]</span><br><span class="line">                    v = kp[<span class="number">2</span>::<span class="number">3</span>]</span><br><span class="line">                    <span class="keyword">for</span> sk <span class="keyword">in</span> sks:</span><br><span class="line">                        <span class="keyword">if</span> np.all(v[sk]&gt;<span class="number">0</span>):</span><br><span class="line">                            plt.plot(x[sk],y[sk], linewidth=<span class="number">3</span>, color=c)</span><br><span class="line">                    plt.plot(x[v&gt;<span class="number">0</span>], y[v&gt;<span class="number">0</span>],<span class="string">'o'</span>,markersize=<span class="number">8</span>, markerfacecolor=c, markeredgecolor=<span class="string">'k'</span>,markeredgewidth=<span class="number">2</span>)</span><br><span class="line">                    plt.plot(x[v&gt;<span class="number">1</span>], y[v&gt;<span class="number">1</span>],<span class="string">'o'</span>,markersize=<span class="number">8</span>, markerfacecolor=c, markeredgecolor=c, markeredgewidth=<span class="number">2</span>)</span><br><span class="line">            p = PatchCollection(polygons, facecolor=color, linewidths=<span class="number">0</span>, alpha=<span class="number">0.4</span>)</span><br><span class="line">            ax.add_collection(p)</span><br><span class="line">            p = PatchCollection(polygons, facecolor=<span class="string">'none'</span>, edgecolors=color, linewidths=<span class="number">2</span>)</span><br><span class="line">            ax.add_collection(p)</span><br><span class="line">        <span class="keyword">elif</span> datasetType == <span class="string">'captions'</span>:</span><br><span class="line">            <span class="keyword">for</span> ann <span class="keyword">in</span> anns:</span><br><span class="line">                print(ann[<span class="string">'caption'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loadRes</span><span class="params">(self, resFile)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Load result file and return a result api object.</span></span><br><span class="line"><span class="string">        :param   resFile (str)     : file name of result file</span></span><br><span class="line"><span class="string">        :return: res (obj)         : result api object</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        res = COCO()</span><br><span class="line">        res.dataset[<span class="string">'images'</span>] = [img <span class="keyword">for</span> img <span class="keyword">in</span> self.dataset[<span class="string">'images'</span>]]</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'Loading and preparing results...'</span>)</span><br><span class="line">        tic = time.time()</span><br><span class="line">        <span class="keyword">if</span> type(resFile) == str <span class="keyword">or</span> type(resFile) == unicode:</span><br><span class="line">            anns = json.load(open(resFile))</span><br><span class="line">        <span class="keyword">elif</span> type(resFile) == np.ndarray:</span><br><span class="line">            anns = self.loadNumpyAnnotations(resFile)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            anns = resFile</span><br><span class="line">        <span class="keyword">assert</span> type(anns) == list, <span class="string">'results in not an array of objects'</span></span><br><span class="line">        annsImgIds = [ann[<span class="string">'image_id'</span>] <span class="keyword">for</span> ann <span class="keyword">in</span> anns]</span><br><span class="line">        <span class="keyword">assert</span> set(annsImgIds) == (set(annsImgIds) &amp; set(self.getImgIds())), \</span><br><span class="line">               <span class="string">'Results do not correspond to current coco set'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'caption'</span> <span class="keyword">in</span> anns[<span class="number">0</span>]:</span><br><span class="line">            imgIds = set([img[<span class="string">'id'</span>] <span class="keyword">for</span> img <span class="keyword">in</span> res.dataset[<span class="string">'images'</span>]]) &amp; set([ann[<span class="string">'image_id'</span>] <span class="keyword">for</span> ann <span class="keyword">in</span> anns])</span><br><span class="line">            res.dataset[<span class="string">'images'</span>] = [img <span class="keyword">for</span> img <span class="keyword">in</span> res.dataset[<span class="string">'images'</span>] <span class="keyword">if</span> img[<span class="string">'id'</span>] <span class="keyword">in</span> imgIds]</span><br><span class="line">            <span class="keyword">for</span> id, ann <span class="keyword">in</span> enumerate(anns):</span><br><span class="line">                ann[<span class="string">'id'</span>] = id+<span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">'bbox'</span> <span class="keyword">in</span> anns[<span class="number">0</span>] <span class="keyword">and</span> <span class="keyword">not</span> anns[<span class="number">0</span>][<span class="string">'bbox'</span>] == []:</span><br><span class="line">            res.dataset[<span class="string">'categories'</span>] = copy.deepcopy(self.dataset[<span class="string">'categories'</span>])</span><br><span class="line">            <span class="keyword">for</span> id, ann <span class="keyword">in</span> enumerate(anns):</span><br><span class="line">                bb = ann[<span class="string">'bbox'</span>]</span><br><span class="line">                x1, x2, y1, y2 = [bb[<span class="number">0</span>], bb[<span class="number">0</span>]+bb[<span class="number">2</span>], bb[<span class="number">1</span>], bb[<span class="number">1</span>]+bb[<span class="number">3</span>]]</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="string">'segmentation'</span> <span class="keyword">in</span> ann:</span><br><span class="line">                    ann[<span class="string">'segmentation'</span>] = [[x1, y1, x1, y2, x2, y2, x2, y1]]</span><br><span class="line">                ann[<span class="string">'area'</span>] = bb[<span class="number">2</span>]*bb[<span class="number">3</span>]</span><br><span class="line">                ann[<span class="string">'id'</span>] = id+<span class="number">1</span></span><br><span class="line">                ann[<span class="string">'iscrowd'</span>] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">'segmentation'</span> <span class="keyword">in</span> anns[<span class="number">0</span>]:</span><br><span class="line">            res.dataset[<span class="string">'categories'</span>] = copy.deepcopy(self.dataset[<span class="string">'categories'</span>])</span><br><span class="line">            <span class="keyword">for</span> id, ann <span class="keyword">in</span> enumerate(anns):</span><br><span class="line">                <span class="comment"># now only support compressed RLE format as segmentation results</span></span><br><span class="line">                ann[<span class="string">'area'</span>] = maskUtils.area(ann[<span class="string">'segmentation'</span>])</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="string">'bbox'</span> <span class="keyword">in</span> ann:</span><br><span class="line">                    ann[<span class="string">'bbox'</span>] = maskUtils.toBbox(ann[<span class="string">'segmentation'</span>])</span><br><span class="line">                ann[<span class="string">'id'</span>] = id+<span class="number">1</span></span><br><span class="line">                ann[<span class="string">'iscrowd'</span>] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">'keypoints'</span> <span class="keyword">in</span> anns[<span class="number">0</span>]:</span><br><span class="line">            res.dataset[<span class="string">'categories'</span>] = copy.deepcopy(self.dataset[<span class="string">'categories'</span>])</span><br><span class="line">            <span class="keyword">for</span> id, ann <span class="keyword">in</span> enumerate(anns):</span><br><span class="line">                s = ann[<span class="string">'keypoints'</span>]</span><br><span class="line">                x = s[<span class="number">0</span>::<span class="number">3</span>]</span><br><span class="line">                y = s[<span class="number">1</span>::<span class="number">3</span>]</span><br><span class="line">                x0,x1,y0,y1 = np.min(x), np.max(x), np.min(y), np.max(y)</span><br><span class="line">                ann[<span class="string">'area'</span>] = (x1-x0)*(y1-y0)</span><br><span class="line">                ann[<span class="string">'id'</span>] = id + <span class="number">1</span></span><br><span class="line">                ann[<span class="string">'bbox'</span>] = [x0,y0,x1-x0,y1-y0]</span><br><span class="line">        print(<span class="string">'DONE (t=&#123;:0.2f&#125;s)'</span>.format(time.time()- tic))</span><br><span class="line"></span><br><span class="line">        res.dataset[<span class="string">'annotations'</span>] = anns</span><br><span class="line">        res.createIndex()</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(self, tarDir = None, imgIds = [] )</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        Download COCO images from mscoco.org server.</span></span><br><span class="line"><span class="string">        :param tarDir (str): COCO results directory name</span></span><br><span class="line"><span class="string">               imgIds (list): images to be downloaded</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        <span class="keyword">if</span> tarDir <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            print(<span class="string">'Please specify target directory'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">        <span class="keyword">if</span> len(imgIds) == <span class="number">0</span>:</span><br><span class="line">            imgs = self.imgs.values()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            imgs = self.loadImgs(imgIds)</span><br><span class="line">        N = len(imgs)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(tarDir):</span><br><span class="line">            os.makedirs(tarDir)</span><br><span class="line">        <span class="keyword">for</span> i, img <span class="keyword">in</span> enumerate(imgs):</span><br><span class="line">            tic = time.time()</span><br><span class="line">            fname = os.path.join(tarDir, img[<span class="string">'file_name'</span>])</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(fname):</span><br><span class="line">                urlretrieve(img[<span class="string">'coco_url'</span>], fname)</span><br><span class="line">            print(<span class="string">'downloaded &#123;&#125;/&#123;&#125; images (t=&#123;:0.1f&#125;s)'</span>.format(i, N, time.time()- tic))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loadNumpyAnnotations</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Convert result data from a numpy array [Nx7] where each row contains &#123;imageID,x1,y1,w,h,score,class&#125;</span></span><br><span class="line"><span class="string">        :param  data (numpy.ndarray)</span></span><br><span class="line"><span class="string">        :return: annotations (python nested list)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        print(<span class="string">'Converting ndarray to lists...'</span>)</span><br><span class="line">        <span class="keyword">assert</span>(type(data) == np.ndarray)</span><br><span class="line">        print(data.shape)</span><br><span class="line">        <span class="keyword">assert</span>(data.shape[<span class="number">1</span>] == <span class="number">7</span>)</span><br><span class="line">        N = data.shape[<span class="number">0</span>]</span><br><span class="line">        ann = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(N):</span><br><span class="line">            <span class="keyword">if</span> i % <span class="number">1000000</span> == <span class="number">0</span>:</span><br><span class="line">                print(<span class="string">'&#123;&#125;/&#123;&#125;'</span>.format(i,N))</span><br><span class="line">            ann += [&#123;</span><br><span class="line">                <span class="string">'image_id'</span>  : int(data[i, <span class="number">0</span>]),</span><br><span class="line">                <span class="string">'bbox'</span>  : [ data[i, <span class="number">1</span>], data[i, <span class="number">2</span>], data[i, <span class="number">3</span>], data[i, <span class="number">4</span>] ],</span><br><span class="line">                <span class="string">'score'</span> : data[i, <span class="number">5</span>],</span><br><span class="line">                <span class="string">'category_id'</span>: int(data[i, <span class="number">6</span>]),</span><br><span class="line">                &#125;]</span><br><span class="line">        <span class="keyword">return</span> ann</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">annToRLE</span><span class="params">(self, ann)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Convert annotation which can be polygons, uncompressed RLE to RLE.</span></span><br><span class="line"><span class="string">        :return: binary mask (numpy 2D array)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        t = self.imgs[ann[<span class="string">'image_id'</span>]]</span><br><span class="line">        h, w = t[<span class="string">'height'</span>], t[<span class="string">'width'</span>]</span><br><span class="line">        segm = ann[<span class="string">'segmentation'</span>]</span><br><span class="line">        <span class="keyword">if</span> type(segm) == list:</span><br><span class="line">            <span class="comment"># polygon -- a single object might consist of multiple parts</span></span><br><span class="line">            <span class="comment"># we merge all parts into one mask rle code</span></span><br><span class="line">            rles = maskUtils.frPyObjects(segm, h, w)</span><br><span class="line">            rle = maskUtils.merge(rles)</span><br><span class="line">        <span class="keyword">elif</span> type(segm[<span class="string">'counts'</span>]) == list:</span><br><span class="line">            <span class="comment"># uncompressed RLE</span></span><br><span class="line">            rle = maskUtils.frPyObjects(segm, h, w)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># rle</span></span><br><span class="line">            rle = ann[<span class="string">'segmentation'</span>]</span><br><span class="line">        <span class="keyword">return</span> rle</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">annToMask</span><span class="params">(self, ann)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Convert annotation which can be polygons, uncompressed RLE, or RLE to binary mask.</span></span><br><span class="line"><span class="string">        :return: binary mask (numpy 2D array)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        rle = self.annToRLE(ann)</span><br><span class="line">        m = maskUtils.decode(rle)</span><br><span class="line">        <span class="keyword">return</span> m</span><br></pre></td></tr></table></figure>
    </div>

    

    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a href="https://github.com/klugjo" target="_blank" rel="noopener">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2020/08/18/%E5%9B%A0%E6%9E%9C%E5%8D%B7%E7%A7%AF%E5%92%8C%E6%89%A9%E5%B1%95%E5%8D%B7%E7%A7%AF/">因果卷积和扩展卷积</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2020/08/18/CasualCNN/">CasualCNN</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2020/08/18/%E6%97%B6%E9%97%B4%E5%8D%B7%E7%A7%AF%E7%BD%91%E7%BB%9C(TCN)%EF%BC%9A%E7%BB%93%E6%9E%84+pytorch%E4%BB%A3%E7%A0%81/">时间卷积网络(TCN)：结构+pytorch代码</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2020/07/19/%E3%80%90%E4%BA%BA%E4%BD%93%E5%A7%BF%E6%80%81%E3%80%91Stacked%20Hourglass%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/">【人体姿态】Stacked Hourglass算法</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/klugjo/hexo-theme-alpha-dust" target="_blank" rel="noopener">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/?lang=en" target="_blank" rel="noopener">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/" target="_blank" rel="noopener">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.instagram.com/" target="_blank" rel="noopener">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://dribbble.com/" target="_blank" rel="noopener">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://plus.google.com/" target="_blank" rel="noopener">
                            <span class="footer-icon-container">
                                <i class="fa fa-google-plus"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.behance.net/" target="_blank" rel="noopener">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://500px.com/" target="_blank" rel="noopener">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a href="http://www.codeblocq.com/" target="_blank" rel="noopener">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->

<script src="/js/main.js"></script>


<!-- Disqus Comments -->



</body>

</html>